<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>realtime tweets</title>
    <script src="../javascript/security/functions_cryptography.js"></script>
    <script src="../javascript/security/enc-base64.js"></script>
    <script src="../javascript/jquery/v.1.6.4/jquery-1.6.4.min.js"></script>
    <script src="../javascript/util/guid.js"></script>
    <script src="../javascript/realtime/eventSubscribersBus.js"></script>
    <script src="../javascript/realtime/serverFeedBackEvent.js"></script>
    <script src="../javascript/api/clientapi.js"></script>
    <script src="../javascript/api/middleware.js"></script>
    <script type="text/javascript">

        var wsToken;
        var clientid;
        var connection;
        /*
        var connection = new WebSocket('ws://localhost:51500/api/connect-websocket');

        connection.onopen = function(ev) {
            console.log("connected");
            var package = { id: "A0409", name: "Josep", surnames: "Lagunas Calpe", number: 669989076 };

            var strPackage = JSON.stringify(package);

            var hashedParameters = CryptoJS.enc.Base64.stringify(CryptoJS.SHA1(strPackage));

            var transferPackage = { HashedKey: hashedParameters, Data: package };
            
            connection.send(JSON.stringify(transferPackage));            
        }

        connection.onmessage = function (e) {
            console.log(e.data);
        }

        */
    

        clientApi.getInstance().requestWSToken(false, true,
            function (status, data) {

                wsToken = data.wstoken;
                clientid = data.clientid;

                console.log("client id: " + data.clientid + " wstoken: " + wsToken);

                connection = clientApi.getInstance().openWebSocketConnection(clientid, wsToken);
                connection.onopen = function (clientId, wsToken) {
                    return function (e) {
                        onWSOpen(clientId, wsToken);
                    }
                }(clientid, wsToken);
                
                connection.onmessage = onWSMessage;
                connection.onclose = onWSClose;

            },
            function (error) {
                console.log(error);
            });

        function onWSMessage(e) {
            console.log(e.data);
        }

        function onWSError(Error) {
            console.log(Error);
        }

        function onWSOpen(clientId, wsToken) {
            DoWork(connection, wsToken, clientid);
        }

        function onWSClose() {
            console.log("close");
        }

        function DoWork(connection, wsToken, clientId) {
                        
            for (var i = 0; i < 30; i++) {

                var package = getTestPackage();

                var strPackage = JSON.stringify(package);

                var hashedParameters = CryptoJS.enc.Base64.stringify(CryptoJS.SHA1(strPackage + wsToken));

                var transferPackage = { clientId: clientid, HashedKey: hashedParameters, Data: package };

                connection.send(JSON.stringify(transferPackage));
            }
        }

        function getTestPackage() {
            if (new Date().getMilliseconds() % 2 == 0) {
                return { id: "A0409", name: "Josep", surnames: "Lagunas Calpe", number: new Date().getMilliseconds() };
            } else {
                return { serial: { a: 1, b: 2 }, types: [{ t1: 'a' }, { t2: 'b' }], timeStamp: new Date().getMilliseconds() };
            }
        }
        
    </script>
</head>
<body>

</body>
</html>